你当前正在访问 Microsoft Azure Global Edition 技术文档网站。 如果需要访问由世纪互联运营的 Microsoft Azure 中国技术文档网站，请访问 [https://docs.azure.cn](https://docs.azure.cn/)。

## 快速入门：使用 Visual Studio 在 Azure 中创建第一个 C# 函数

+   项目
+   03/04/2024

## 本文内容

Azure Functions 让你可以使用 Visual Studio 创建本地 C# 函数项目，然后轻松发布此项目以在 Azure 中的可缩放无服务器环境中运行。 如果更喜欢使用 Visual Studio Code 在本地开发 C# 应用，应改为考虑本文的[基于 Visual Studio Code 的版本](https://learn.microsoft.com/zh-cn/azure/azure-functions/create-first-function-vs-code-csharp)。

默认情况下，本文介绍如何在[隔离的工作进程](https://learn.microsoft.com/zh-cn/azure/azure-functions/dotnet-isolated-process-guide)中创建在 .NET 8 上运行的 C# 函数。 Functions 支持的所有 .NET 版本都支持在独立工作进程中运行的函数应用。 有关详细信息，请参阅[支持的版本](https://learn.microsoft.com/zh-cn/azure/azure-functions/dotnet-isolated-process-guide#supported-versions)。

在本文中，学习如何：

+   使用 Visual Studio 创建 C# 类库项目。
+   创建响应 HTTP 请求的函数。
+   在本地运行代码以验证函数行为。
+   将代码项目部署到 Azure Functions。

完成本快速入门会从你的 Azure 帐户中扣取最多几美分的费用。

此视频展示了如何在 Azure 中创建 C# 函数。

视频中的步骤也在以下部分进行了介绍。

## 先决条件

+   [Visual Studio 2022](https://visualstudio.microsoft.com/vs/)。 请确保在安装过程中选择“Azure 开发”工作负载。
    
+   [Azure 订阅](https://learn.microsoft.com/zh-cn/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing)。 如果还没有帐户，请在开始之前[创建免费帐户](https://azure.microsoft.com/free/dotnet/)。
    

## 创建函数应用项目

Visual Studio 中的 Azure Functions 项目模板创建了一个 C# 类库项目，该项目可发布到 Azure 中的函数应用。 可使用函数应用将函数分组为逻辑单元，以便更轻松地管理、部署、缩放和共享资源。

1.  在 Visual Studio 菜单中，选择“文件”>“新建”>“项目”。
    
2.  在“创建新项目”中，在搜索框中输入“functions”，选择“Azure Functions”模板，然后选择“下一步”。
    
3.  在“配置新项目”中，输入项目的“项目名称”，然后选择“下一步”。 函数应用名称必须可以充当 C# 命名空间，因此请勿使用下划线、连字符或任何其他的非字母数字字符。
    
4.  对于剩余的“**其他信息**”设置，
    
    | 设置                                                    | 值                            | 说明                                                         |
    | ------------------------------------------------------- | ----------------------------- | ------------------------------------------------------------ |
    | **Functions 辅助角色**                                  | **.NET 8.0 隔离（长期支持）** | 你的函数在隔离的工作进程中在 .NET 8 上运行。                 |
    | **Function**                                            | **HTTP 触发器**               | 此值会创建由 HTTP 请求触发的函数。                           |
    | **将 Azurite 用于运行时存储账户 (AzureWebJobsStorage)** | 启用                          | 由于 Azure 中的函数应用需要存储帐户，因此在将项目发布到 Azure 时会分配或创建一个存储帐户。 HTTP 触发器不使用 Azure 存储帐户连接字符串；所有其他触发器类型需要有效的 Azure 存储帐户连接字符串。 选择此选项后，将使用 [Azurite 仿真器](https://learn.microsoft.com/zh-cn/azure/storage/common/storage-use-azurite?tabs=visual-studio)。 |
    | **授权级别**                                            | **匿名**                      | 在未提供密钥的情况下，任何客户端都可以触发创建的函数。 通过此授权设置可以轻松测试新函数。 有关详细信息，请参阅[授权级别](https://learn.microsoft.com/zh-cn/azure/azure-functions/functions-bindings-http-webhook-trigger#http-auth)。 |
    
    ![Azure Functions 项目设置的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vs-tools-create/functions-project-settings-v4-isolated.png)
    
    请确保将“授权级别”设置为“匿名”。 如果选择默认级别的函数，需要在请求中提供[函数密钥](https://learn.microsoft.com/zh-cn/azure/azure-functions/function-keys-how-to)才能访问 Azure 中的函数终结点。
    
5.  选择“创建”以创建函数项目和 HTTP 触发器函数。
    

Visual Studio 将创建一个项目和一个包含 HTTP 触发器函数类型样本代码的类。 样本代码发送 HTTP 响应，其中包含来自请求正文或查询字符串的值。 `HttpTrigger` 属性指定该函数将由某个 HTTP 请求触发。

## 重命名函数

`Function` 方法属性设置函数的名称（默认情况下生成为 `Function1`）。 由于工具不允许在创建项目时覆盖默认函数名称，请花一点时间为函数类、文件和元数据创建更好的名称。

1.  在“文件资源管理器”中，右键单击 Function1.cs 文件并将其重命名为 `HttpExample.cs`。
    
2.  在代码中，将 Function1 类重命名为 `HttpExample`。
    
3.  在名为 `Run` 的方法中，将 `Function` 方法属性重命名为 `HttpExample`。
    

函数定义现在应如以下代码所示：

```csharp
[Function("HttpExample")]
public IActionResult Run([HttpTrigger(AuthorizationLevel.AuthLevelValue, "get", "post")] HttpRequest req)
{
    return new OkObjectResult("Welcome to Azure Functions!");
}
```

重命名函数以后，即可在本地计算机上对其进行测试。

## 在本地运行函数

Visual Studio 与 Azure Functions Core Tools 集成，这样你便可使用完整的 Azure Functions 运行时在本地测试函数。

1.  若要运行函数，请在 Visual Studio 中按 F5。 你可能需要启用防火墙例外，这样工具才能处理 HTTP 请求。 在本地运行函数时，永远不会强制实施授权级别。
    
2.  从 Azure Functions 运行时输出复制函数的 URL。
    
    ![Azure 本地运行时](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-run-function-test-local-vs/functions-debug-local-vs.png)
    
3.  将 HTTP 请求的 URL 粘贴到浏览器的地址栏中并运行请求。 下图显示了浏览器中由函数返回的本地 GET 请求的响应：
    
    ![浏览器中的函数 localhost 响应](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-run-function-test-local-vs/functions-run-browser-local-vs.png)
    
4.  若要停止调试，请在 Visual Studio 中按 Shift+F5。
    

确认该函数可以在本地计算机上正确运行以后，即可将项目发布到 Azure。

## 将项目发布到 Azure

Visual Studio 可以将本地项目发布到 Azure。 必须在 Azure 订阅中有一个函数应用，然后才能发布项目。 如果 Azure 中还没有函数应用，Visual Studio 发布会在你首次发布项目时为你创建一个函数应用。 本文介绍如何创建函数应用和相关的 Azure 资源。

1.  **在“解决方案资源管理器”** 中，右键单击该项目并选择“发布”。 在“目标”中选择“Azure”，然后选择“下一步”。
    
    ![“发布”窗格的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-publish/functions-vs-publish.png)
    
2.  在“特定目标”上，选择“Azure 函数应用(Windows)”。 这会创建一个在 Windows 上运行的函数应用。 选择**下一步**。
    
    ![具有特定目标的“发布”窗格的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-publish/functions-vs-specific-target.png)
    
3.  在“函数实例”上，选择“创建新的 Azure 函数”。
    
    ![显示“创建新函数应用实例”的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-publish/functions-vs-functions-instance.png)
    
4.  使用下表中指定的值创建新实例：
    
    | 设置                                                         | 值                        | 描述                                                         |
    | ------------------------------------------------------------ | ------------------------- | ------------------------------------------------------------ |
    | **名称**                                                     | 全局唯一名称              | 用于唯一标识新 Function App 的名称。 接受此名称或输入新名称。 有效的字符是 `a-z`、`0-9` 和 `-`。 |
    | **订阅**                                                     | 你的订阅                  | 要使用的 Azure 订阅。 接受此订阅，或从下拉列表中选择一个新订阅。 |
    | **[资源组](https://learn.microsoft.com/zh-cn/azure/azure-resource-manager/management/overview)** | 资源组的名称              | 你要在其中创建函数应用的资源组。 选择“新建”来创建一个新的资源组。 也可以选择使用下拉列表中的现有资源组。 |
    | **[计划类型](https://learn.microsoft.com/zh-cn/azure/azure-functions/functions-scale)** | 消耗                      | 将项目发布到在[消耗计划](https://learn.microsoft.com/zh-cn/azure/azure-functions/consumption-plan)中运行的函数应用时，只需为函数应用的执行付费。 其他托管计划会产生更高的成本。 |
    | **位置**                                                     | 应用服务的位置            | 在靠近你或者靠近函数访问的其他服务的 [Azure 区域](https://azure.microsoft.com/regions/)中选择一个位置。 |
    | **[Azure 存储](https://learn.microsoft.com/zh-cn/azure/azure-functions/storage-considerations)** | 常规用途存储帐户          | Functions 运行时需要 Azure 存储帐户。 选择“新建”即可配置常规用途存储帐户。 也可以选择使用符合[存储帐户要求](https://learn.microsoft.com/zh-cn/azure/azure-functions/storage-considerations#storage-account-requirements)的现有帐户。 |
    | **[Application Insights](https://learn.microsoft.com/zh-cn/azure/azure-functions/functions-monitoring)** | Application Insights 实例 | 应为函数应用启用 Azure Application Insights 集成。 选择“新建”以在新的或现有的 Log Analytics 工作区中创建新实例。 也可以选择使用现有的实例。 |
    
    ![“创建应用服务”对话框的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-publish/functions-vs-function-app.png)
    
5.  选择“创建”，在 Azure 中创建一个函数应用及其相关资源。 资源创建的状态显示在窗口左下角。
    
6.  在“函数实例”上，确保已选中“从包文件运行”复选框。 在启用[从包运行](https://learn.microsoft.com/zh-cn/azure/azure-functions/run-functions-from-deployment-package)模式的情况下使用 [Zip 部署](https://learn.microsoft.com/zh-cn/azure/azure-functions/functions-deployment-technologies#zip-deploy)来部署函数应用。 建议为你的函数项目使用 Zip 部署方法，以提高性能。
    
    ![“完成配置文件创建”窗格的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-publish/functions-vs-publish-profile-step-4.png)
    
7.  选择“完成”，然后在“发布”窗格上选择“发布”，将包含项目文件的包部署到 Azure 中的新函数应用。
    
    部署完成后，Azure 中函数应用的根 URL 将显示在“发布”选项卡上。
    
8.  在“发布”选项卡上的“托管”部分中，选择“在 Azure 门户中打开”。 新的函数应用 Azure 资源将在 Azure 门户中打开。
    
    ![发布成功消息的屏幕截图。](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-publish/functions-visual-studio-publish-complete.png)
    

## 在 Azure 中验证函数

1.  在 Azure 门户中，你应位于新函数应用的“概述”页中。
    
2.  在“函数”下，选择名为“HttpExample”的新函数，然后在函数页中选择“获取函数 URL”，然后选择“复制到剪贴板”图标。
    
3.  在浏览器中的地址栏中，粘贴刚刚复制的 URL 并运行该请求。
    
    调用 HTTP 触发器函数的 URL 采用以下格式：
    
    `https://<APP_NAME>.azurewebsites.net/api/HttpExample?name=Functions`
    
4.  转到此 URL，你会在浏览器中看到函数返回的对远程 GET 请求的响应，如下例所示：
    
    ![浏览器中的函数响应](https://learn.microsoft.com/zh-cn/azure/azure-functions/media/functions-create-your-first-function-visual-studio/functions-create-your-first-function-visual-studio-browser-azure.png)
    

## 清理资源

Azure 中的资源是指函数应用、函数、存储帐户等。 这些资源可以组合到资源组中，删除该组即可删除组中的所有内容。

你已创建 Azure 资源来完成本快速入门。 这些资源可能需要付费，具体取决于[帐户状态](https://azure.microsoft.com/account/)和[服务定价](https://azure.microsoft.com/pricing/)。 本教程系列中的其他快速入门教程是在本文的基础上制作的。 如果打算使用后续的快速入门、教程或者在本快速入门中创建的任何服务，请勿清理这些资源。

请使用以下步骤删除函数应用及其相关资源，以免产生任何额外的费用。

1.  在“Visual Studio 发布”对话框中的“托管”部分中，选择**“在 Microsoft Azure 门户中打开”**。
    
2.  在函数应用页中，请选择“概览”选项卡，然后选择“资源组”下的链接 。
    
    ![从函数应用页选择要删除的资源组](https://learn.microsoft.com/zh-cn/azure/includes/media/functions-vstools-cleanup/functions-app-delete-resource-group.png)
    
3.  在“资源组”页中查看所包括的资源的列表，然后验证这些资源是否是要删除的。
    
4.  选择“删除资源组”，然后按说明操作。
    
    可能需要数分钟才能删除完毕。 完成后会显示一个通知，持续数秒。 也可以选择页面顶部的钟形图标来查看通知。
    

## 后续步骤

在本快速入门中，你已使用 Visual Studio，在 Azure 中创建并发布了一个 C# 函数应用，其中包含一个简单的 HTTP 触发器函数。

若要详细了解如何使用在独立工作进程中运行的 C# 函数，请参阅[在独立工作进程中运行 C# Azure Functions 的指南](https://learn.microsoft.com/zh-cn/azure/azure-functions/dotnet-isolated-process-guide)。 请查看 [.NET 支持的版本](https://learn.microsoft.com/zh-cn/azure/azure-functions/functions-dotnet-class-library#supported-versions)，了解独立工作进程中受支持的 .NET 版本的其他版本。

请转到下一篇文章，了解如何将一个 Azure 存储队列绑定添加到函数：